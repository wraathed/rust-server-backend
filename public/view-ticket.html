<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Ticket - Classic Rust</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .chat-container { background-color: var(--bg-panel); border: 1px solid #333; border-radius: 10px; padding: 20px; max-width: 900px; margin: 0 auto; }
        .chat-header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        .messages-area { display: flex; flex-direction: column; gap: 15px; height: 500px; overflow-y: auto; margin-bottom: 20px; padding-right: 10px; }
        
        .message-row { display: flex; gap: 15px; max-width: 80%; }
        .message-row.me { align-self: flex-end; flex-direction: row-reverse; text-align: right; }
        .message-row.me .message-bubble { background-color: var(--primary-orange); color: black; border-top-left-radius: 10px; border-top-right-radius: 0; }
        .message-row.me .sender-name { color: #333; }
        
        .message-row.other { align-self: flex-start; text-align: left; }
        .message-row.other .message-bubble { background-color: #2a2a2a; color: #ddd; border-top-left-radius: 0; border-top-right-radius: 10px; }
        .message-row.other .sender-name { color: #888; }

        .message-bubble { padding: 15px; border-radius: 10px; position: relative; word-wrap: break-word; }
        .sender-name { font-size: 11px; margin-bottom: 4px; display: block; font-weight: bold; }
        
        .admin-tag { background: #ff4444; color: white; font-size: 10px; padding: 2px 5px; border-radius: 3px; margin-left: 5px; text-transform: uppercase; vertical-align: middle; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; }
        
        .reply-box { display: flex; gap: 10px; border-top: 1px solid #333; padding-top: 20px; }
        .reply-box.disabled { opacity: 0.5; pointer-events: none; }

        /* Admin Controls Styling */
        #admin-controls { display: none; gap: 8px; flex-wrap: wrap; }
        #admin-controls .btn { padding: 6px 12px; font-size: 11px; text-decoration: none; display: inline-flex; align-items: center; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo"><img src="assets/logo.png" alt="Logo"></a>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="profile.html">My Profile</a></li>
            </ul>
        </nav>
        <div id="auth-section">
            <a href="/auth/steam" class="steam-login">
                <img src="assets/steam.png" alt="Steam">
                Sign in with Steam
            </a>
        </div>
    </header>

    <div class="container">
        
        <!-- NEW: Back Button Wrapper (Outside Chat Container) -->
        <div id="admin-back-wrapper" style="max-width: 900px; margin: 0 auto 10px auto; display: none;">
            <a href="admin.html" class="btn" style="background: #444; color: black; font-weight: bold; display: inline-block;">
                &larr; Back to Panel
            </a>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div style="flex: 1;">
                    <h2 id="ticket-subject" style="border:none; margin:0; padding:0;">Loading...</h2>
                    <p id="ticket-id" style="color:#888; font-size:14px;">#...</p>
                </div>
                
                <!-- Admin Controls -->
                <div id="admin-controls">
                    <!-- 1. View Steam Profile -->
                    <a id="steam-profile-link" href="#" target="_blank" class="btn" style="background: #444; color: black;">
                        <img src="assets/steam.png" style="width:16px; height:16px; margin-right:5px;"> Profile
                    </a>

                    <!-- 2. Status Buttons -->
                    <button onclick="changeStatus('Open')" class="btn" style="background:#2ecc71; color: black;">Re-Open</button>
                    <button onclick="changeStatus('Closed')" class="btn" style="background:#e74c3c; color: black;">Close</button>
                </div>
                
                <div id="ticket-status" style="font-weight:bold; color:var(--primary-orange); margin-left: 15px;">Open</div>
            </div>

            <div id="messages-area" class="messages-area"></div>

            <div class="reply-box" id="reply-box">
                <textarea id="reply-content" rows="2" placeholder="Write a reply..." style="resize:none;"></textarea>
                <button onclick="sendReply()" class="btn btn-primary" id="send-btn">Send</button>
            </div>
            <p id="closed-message" style="display:none; text-align:center; color:#ff4444; margin-top:10px; font-weight:bold;">This ticket is closed. No further replies allowed.</p>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="loader.js"></script>
    <script>
        const API_BASE = ''; 
        const params = new URLSearchParams(window.location.search);
        const ticketId = params.get('id');

        if (!ticketId) window.location.href = 'profile.html';

        let isFirstLoad = true;

        async function loadTicket() {
            try {
                const res = await fetch(`${API_BASE}/api/ticket/${ticketId}`, { credentials: 'include' });
                
                if (res.status === 403 || res.status === 401) {
                    alert("Unauthorized access.");
                    window.location.href = 'index.html';
                    return;
                }

                const data = await res.json();
                const { ticket, messages, currentUserSteamId, isAdmin } = data;

                // 1. Update Header Info
                document.getElementById('ticket-subject').innerText = ticket.subject;
                document.getElementById('ticket-id').innerText = `Ticket #${ticket.id} - ${ticket.category}`;
                document.getElementById('ticket-status').innerText = ticket.status;

                // 2. Handle Closed State
                const replyBox = document.getElementById('reply-box');
                const closedMsg = document.getElementById('closed-message');

                if (ticket.status === 'Closed') {
                    replyBox.classList.add('disabled');
                    document.getElementById('reply-content').disabled = true;
                    document.getElementById('send-btn').disabled = true;
                    closedMsg.style.display = 'block';
                } else {
                    replyBox.classList.remove('disabled');
                    document.getElementById('reply-content').disabled = false;
                    document.getElementById('send-btn').disabled = false;
                    closedMsg.style.display = 'none';
                }

                // 3. Show Admin Controls
                if (isAdmin) {
                    document.getElementById('admin-controls').style.display = 'flex';
                    // Show the "Back to Panel" button outside the box
                    document.getElementById('admin-back-wrapper').style.display = 'block';
                    
                    const steamId = ticket.steamid || ticket.steamId; 
                    document.getElementById('steam-profile-link').href = `https://steamcommunity.com/profiles/${steamId}`;
                }

                // 4. Render Messages
                const chatArea = document.getElementById('messages-area');
                const isScrolledToBottom = chatArea.scrollHeight - chatArea.scrollTop <= chatArea.clientHeight + 100;

                let html = '';
                messages.forEach(msg => {
                    const isMe = msg.sender_steamid === currentUserSteamId; 
                    const showAdminBadge = msg.isAdminSender;

                    html += `
                        <div class="message-row ${isMe ? 'me' : 'other'}">
                            <img src="${msg.sender_avatar}" class="avatar">
                            <div class="message-bubble">
                                <span class="sender-name">
                                    ${msg.sender_name}
                                    ${showAdminBadge ? '<span class="admin-tag">ADMIN</span>' : ''}
                                </span>
                                ${msg.content}
                            </div>
                        </div>
                    `;
                });

                if (chatArea.innerHTML !== html) {
                    chatArea.innerHTML = html;
                    if (isFirstLoad || isScrolledToBottom) {
                        chatArea.scrollTop = chatArea.scrollHeight;
                        isFirstLoad = false;
                    }
                }

            } catch (err) {
                console.error(err);
            }
        }

        async function sendReply() {
            const content = document.getElementById('reply-content').value;
            if (!content.trim()) return;

            const res = await fetch(`${API_BASE}/api/ticket/${ticketId}/reply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ content })
            });

            if (res.ok) {
                document.getElementById('reply-content').value = '';
                loadTicket(); 
            } else {
                const err = await res.json();
                alert(err.error || "Failed to send message");
            }
        }

        async function changeStatus(newStatus) {
            await fetch(`${API_BASE}/api/ticket/${ticketId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ status: newStatus })
            });
            loadTicket();
        }

        loadTicket();
        setInterval(loadTicket, 3000);
    </script>

    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <p>&copy; 2026 Classic Rust. All rights reserved.</p>
                <p class="credits">Designed by <a href="https://aetheriwebdesign.com/" target="_blank">Aetheri Web Design</a></p>
            </div>
            <div class="footer-right">
                <a href="#">Terms of Service</a>
                <a href="#">Privacy Policy</a>
                <a href="https://discord.gg/QdQUvPvg" class="btn btn-discord-small">
                    <img src="assets/discord.png" alt="Discord" style="width: 20px; height: 20px;">
                    Join Discord
                </a>
            </div>
        </div>
    </footer>

</body>
</html>