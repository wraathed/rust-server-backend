<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>View Ticket - Classic Rust</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .chat-container { background-color: var(--bg-panel); border: 1px solid #333; border-radius: 10px; padding: 20px; max-width: 900px; margin: 0 auto; }
        .chat-header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .messages-area { display: flex; flex-direction: column; gap: 15px; max-height: 500px; overflow-y: auto; margin-bottom: 20px; padding-right: 10px; }
        .message-row { display: flex; gap: 15px; max-width: 80%; }
        .message-row.me { align-self: flex-end; flex-direction: row-reverse; text-align: right; }
        .message-bubble { background-color: #2a2a2a; padding: 15px; border-radius: 10px; border-top-left-radius: 0; color: #ddd; position: relative; }
        .message-row.me .message-bubble { background-color: var(--primary-orange); color: black; border-top-left-radius: 10px; border-top-right-radius: 0; }
        .sender-name { font-size: 11px; color: #888; margin-bottom: 4px; display: block; }
        .message-row.me .sender-name { color: #333; }
        .admin-tag { background: #ff4444; color: white; font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-left: 5px; text-transform: uppercase; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; }
        .reply-box { display: flex; gap: 10px; border-top: 1px solid #333; padding-top: 20px; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo"><img src="assets/logo.png" alt="Logo"></a>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="profile.html">My Profile</a></li>
            </ul>
        </nav>
        <div id="auth-section">
            <a href="/auth/steam" class="steam-login">
                <img src="assets/steam.png" alt="Steam">
                Sign in with Steam
            </a>
        </div>
    </header>

    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <h2 id="ticket-subject" style="border:none; margin:0; padding:0;">Loading...</h2>
                    <p id="ticket-id" style="color:#888; font-size:14px;">#...</p>
                </div>
                <div id="admin-controls" style="display:none; gap: 10px;">
                    <button onclick="changeStatus('Open')" class="btn" style="padding:5px 10px; font-size:12px; background:#2ecc71;">Mark Open</button>
                    <button onclick="changeStatus('Closed')" class="btn" style="padding:5px 10px; font-size:12px; background:#e74c3c;">Close Ticket</button>
                </div>
                <div id="ticket-status" style="font-weight:bold; color:var(--primary-orange);">Open</div>
            </div>

            <div id="messages-area" class="messages-area"></div>

            <div class="reply-box">
                <textarea id="reply-content" rows="2" placeholder="Write a reply..." style="resize:none;"></textarea>
                <button onclick="sendReply()" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="loader.js"></script>
    <script>
        const API_BASE = '';
        const params = new URLSearchParams(window.location.search);
        const ticketId = params.get('id');

        if (!ticketId) window.location.href = 'profile.html';

        async function loadTicket() {
            try {
                // IMPORTANT: Added credentials: 'include'
                const res = await fetch(`${API_BASE}/api/ticket/${ticketId}`, { credentials: 'include' });
                
                if (res.status === 403 || res.status === 401) {
                    alert("Unauthorized access.");
                    window.location.href = 'index.html';
                    return;
                }

                const data = await res.json();
                const { ticket, messages, currentUserSteamId, isAdmin } = data;

                document.getElementById('ticket-subject').innerText = ticket.subject;
                document.getElementById('ticket-id').innerText = `Ticket #${ticket.id} - ${ticket.category}`;
                document.getElementById('ticket-status').innerText = ticket.status;

                if (isAdmin) {
                    document.getElementById('admin-controls').style.display = 'flex';
                }

                const chatArea = document.getElementById('messages-area');
                chatArea.innerHTML = '';

                messages.forEach(msg => {
                    const isMe = msg.sender_steamId === currentUserSteamId;
                    const isSupport = msg.sender_steamId !== ticket.steamId; 

                    const rowHtml = `
                        <div class="message-row ${isMe ? 'me' : ''}">
                            <img src="${msg.sender_avatar}" class="avatar">
                            <div class="message-bubble">
                                <span class="sender-name">
                                    ${msg.sender_name}
                                    ${isSupport ? '<span class="admin-tag">STAFF</span>' : ''}
                                </span>
                                ${msg.content}
                            </div>
                        </div>
                    `;
                    chatArea.innerHTML += rowHtml;
                });
                chatArea.scrollTop = chatArea.scrollHeight;
            } catch (err) {
                console.error(err);
            }
        }

        async function sendReply() {
            const content = document.getElementById('reply-content').value;
            if (!content.trim()) return;

            // IMPORTANT: Added credentials: 'include'
            await fetch(`${API_BASE}/api/ticket/${ticketId}/reply`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ content })
            });

            document.getElementById('reply-content').value = '';
            loadTicket(); 
        }

        async function changeStatus(newStatus) {
            // IMPORTANT: Added credentials: 'include'
            await fetch(`${API_BASE}/api/ticket/${ticketId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ status: newStatus })
            });
            loadTicket();
        }

        loadTicket();
    </script>

    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <p>&copy; 2026 Classic Rust. All rights reserved.</p>
                <p class="credits">Designed by <a href="https://aetheriwebdesign.com/" target="_blank">Aetheri Web Design</a></p>
            </div>
            <div class="footer-right">
                <a href="#">Terms of Service</a>
                <a href="#">Privacy Policy</a>
                <a href="https://discord.gg/QdQUvPvg" class="btn btn-discord-small">
                    <img src="assets/discord.png" alt="Discord" style="width: 20px; height: 20px;">
                    Join Discord
                </a>
            </div>
        </div>
    </footer>

</body>
</html>