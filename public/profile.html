<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Classic Rust - Profile</title>
    <link rel="stylesheet" href="style.css">
    <style>
        tbody tr:hover {
            background-color: #2a2a2a;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo">
            <img src="assets/logo.png" alt="Classic Rust Logo">
        </a>
         <div class="menu-toggle">
        <span></span>
        <span></span>
        <span></span>
    </div>
        <nav>
            <ul>
                <li><a href="servers.html">Servers</a></li>
                <li><a href="store.html">Store</a></li>
                <li><a href="create-ticket.html">Create a Ticket</a></li>
                <li><a href="profile.html" class="active">My Profile</a></li>
            </ul>
        </nav>
        <div id="auth-section">
            <a href="/auth/steam" class="steam-login">
                <img src="assets/steam.png" alt="Steam">
                Sign in with Steam
            </a>
        </div>
    </header>

    <div class="container">
        <!-- Profile Header -->
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 40px;">
            <img id="profile-avatar" src="https://avatars.steamstatic.com/fef49e7fa7e1997310d705b2a6158ff8dc1cdfeb_full.jpg" style="width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary-orange);">
            <div id="profile-info">
                <h1 id="profile-name">Loading...</h1>
                <p id="profile-steamid" style="color: var(--text-gray); margin-bottom: 10px;">Please log in...</p>
                <!-- Dynamic Buttons injected here -->
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>My Support Tickets</h2>
            <a href="create-ticket.html" class="btn btn-primary" style="padding: 10px 20px; font-size: 12px;">+ New Ticket</a>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Subject</th>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="ticket-body">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #666;">Loading tickets...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <p>&copy; 2026 Classic Rust. All rights reserved.</p>
                <p class="credits">Designed by <a href="https://aetheriwebdesign.com/" target="_blank">Aetheri Web Design</a></p>
            </div>
            <div class="footer-right">
                <a href="#">Terms of Service</a>
                <a href="#">Privacy Policy</a>
                <a href="https://discord.gg/QdQUvPvg" class="btn btn-discord-small">
                    <img src="assets/discord.png" alt="Discord" style="width: 20px; height: 20px;">
                    Join Discord
                </a>
            </div>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script src="loader.js"></script>
    <script src="mobile.js"></script>
    <script>
        const API_BASE = '';

        // 1. Check User Login & Update Profile
        fetch('/user', { credentials: 'include' })
            .then(res => res.json())
            .then(user => {
                if (user) {
                    // Update Basic Info
                    document.getElementById('profile-avatar').src = user.photos[2].value;
                    document.getElementById('profile-name').innerText = user.displayName;
                    document.getElementById('profile-steamid').innerText = `Steam ID: ${user.id}`;

                    const infoDiv = document.getElementById('profile-info');
                    
                    // --- ACTIONS CONTAINER (Holds Buttons Side-by-Side) ---
                    const actionsContainer = document.createElement('div');
                    actionsContainer.style.marginTop = '15px';
                    actionsContainer.style.display = 'flex';
                    actionsContainer.style.alignItems = 'center';
                    actionsContainer.style.gap = '15px';

                    // 1. DISCORD BUTTON LOGIC
                    if (user.discord) {
                        // LINKED STATUS (Badge)
                        const statusBadge = document.createElement('div');
                        statusBadge.style.backgroundColor = '#43b581';
                        statusBadge.style.color = 'white';
                        statusBadge.style.padding = '8px 12px';
                        statusBadge.style.borderRadius = '5px';
                        statusBadge.style.fontSize = '14px';
                        statusBadge.innerHTML = `<img src="assets/discord.png" style="width:16px; vertical-align:middle; margin-right:5px;"> Linked: <b>${user.discord}</b>`;
                        
                        // UNLINK BUTTON
                        const unlinkBtn = document.createElement('button');
                        unlinkBtn.innerText = 'Unlink';
                        unlinkBtn.className = 'btn';
                        unlinkBtn.style.backgroundColor = '#e74c3c'; // Red
                        unlinkBtn.style.padding = '8px 12px';
                        unlinkBtn.style.fontSize = '12px';
                        unlinkBtn.style.border = 'none';
                        unlinkBtn.style.cursor = 'pointer';
                        unlinkBtn.style.marginLeft = '10px';
                        
                        unlinkBtn.onclick = async () => {
                            if(!confirm("Are you sure you want to unlink your Discord account?")) return;
                            
                            try {
                                const res = await fetch('/auth/discord/unlink', { method: 'POST' });
                                const data = await res.json();
                                if(data.success) {
                                    window.location.reload();
                                } else {
                                    alert("Error unlinking account.");
                                }
                            } catch(e) {
                                console.error(e);
                                alert("Connection error.");
                            }
                        };

                        const discordWrapper = document.createElement('div');
                        discordWrapper.appendChild(statusBadge);
                        discordWrapper.appendChild(unlinkBtn);
                        actionsContainer.appendChild(discordWrapper);

                    } else {
                        // NOT LINKED BUTTON
                        const linkBtn = document.createElement('a');
                        linkBtn.href = '/auth/discord';
                        linkBtn.className = 'btn';
                        linkBtn.style.backgroundColor = '#7289da';
                        linkBtn.style.color = 'white';
                        linkBtn.style.padding = '10px 15px';
                        linkBtn.style.textDecoration = 'none';
                        linkBtn.style.display = 'inline-flex';
                        linkBtn.style.alignItems = 'center';
                        linkBtn.style.borderRadius = '5px';
                        linkBtn.style.gap = '8px';
                        linkBtn.innerHTML = `<img src="assets/discord.png" style="width:20px;"> Link Discord`;
                        
                        actionsContainer.appendChild(linkBtn);
                    }

                    // 2. STEAM GROUP BUTTON LOGIC (NEW)
                    const steamBtn = document.createElement('a');
                    // !!! CHANGE THIS URL TO YOUR STEAM GROUP !!!
                    steamBtn.href = 'https://steamcommunity.com/groups/YOUR_GROUP_URL_HERE'; 
                    steamBtn.target = '_blank';
                    steamBtn.className = 'btn';
                    steamBtn.style.backgroundColor = '#171a21'; // Steam Dark Blue/Black
                    steamBtn.style.color = 'white';
                    steamBtn.style.padding = '10px 15px';
                    steamBtn.style.textDecoration = 'none';
                    steamBtn.style.display = 'inline-flex';
                    steamBtn.style.alignItems = 'center';
                    steamBtn.style.borderRadius = '5px';
                    steamBtn.style.gap = '8px';
                    steamBtn.innerHTML = `<img src="assets/steam.png" style="width:20px;"> Join Steam Group`;
                    
                    actionsContainer.appendChild(steamBtn);

                    // Add Container to Profile Info
                    infoDiv.appendChild(actionsContainer);

                    // --- ADMIN BUTTON ---
                    if (user.isAdmin) {
                        const adminBtn = document.createElement('a');
                        adminBtn.href = 'admin.html';
                        adminBtn.className = 'btn';
                        adminBtn.innerText = 'Open Admin Panel';
                        adminBtn.style.backgroundColor = '#e74c3c';
                        adminBtn.style.color = 'white';
                        adminBtn.style.padding = '8px 15px';
                        adminBtn.style.fontSize = '12px';
                        adminBtn.style.marginTop = '15px';
                        adminBtn.style.display = 'inline-block';
                        infoDiv.appendChild(adminBtn);
                    }

                    // Load Tickets
                    loadMyTickets();
                } else {
                    window.location.href = 'index.html'; 
                }
            })
            .catch(err => {
                console.error("Auth check failed", err);
                window.location.href = 'index.html';
            });

        async function loadMyTickets() {
            try {
                const response = await fetch(`${API_BASE}/api/my-tickets`, { credentials: 'include' });
                const tickets = await response.json();
                const tbody = document.getElementById('ticket-body');
                tbody.innerHTML = ''; 

                if (tickets.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">You haven\'t created any tickets yet.</td></tr>';
                    return;
                }

                tickets.forEach(ticket => {
                    let statusColor = '#aaa';
                    if (ticket.status === 'Open') statusColor = 'var(--primary-orange)';
                    if (ticket.status === 'Answered') statusColor = '#3498db';
                    if (ticket.status === 'Resolved' || ticket.status === 'Closed') statusColor = '#2ecc71';

                    const date = new Date(ticket.created_at).toLocaleDateString();

                    const rowHtml = `
                        <tr onclick="window.location.href='view-ticket.html?id=${ticket.id}'">
                            <td>#${ticket.id}</td>
                            <td style="font-weight: bold; color: white;">${ticket.subject}</td>
                            <td>${ticket.category}</td>
                            <td>${date}</td>
                            <td style="color: ${statusColor}; font-weight: bold;">${ticket.status}</td>
                            <td><a href="view-ticket.html?id=${ticket.id}" class="btn btn-primary" style="padding: 5px 10px; font-size: 11px;">View</a></td>
                        </tr>
                    `;
                    tbody.innerHTML += rowHtml;
                });
            } catch (err) {
                console.error(err);
                document.getElementById('ticket-body').innerHTML = '<tr><td colspan="6" style="color:red; text-align:center;">Error loading tickets.</td></tr>';
            }
        }
    </script>

</body>
</html>