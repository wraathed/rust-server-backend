<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Classic Rust - Profile</title>
    <link rel="stylesheet" href="style.css">
    <style>
        tbody tr:hover { background-color: #2a2a2a; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <a href="index.html" class="logo">
            <img src="assets/logo.png" alt="Classic Rust Logo">
        </a>
         <div class="menu-toggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <nav>
            <ul>
                <li><a href="servers.html">Servers</a></li>
                <li><a href="store.html">Store</a></li>
                <li><a href="create-ticket.html">Create a Ticket</a></li>
                <li><a href="profile.html" class="active">My Profile</a></li>
            </ul>
        </nav>
        <div id="auth-section">
            <a href="/auth/steam" class="steam-login">
                <img src="assets/steam.png" alt="Steam">
                Sign in with Steam
            </a>
        </div>
    </header>

    <div class="container">
        <!-- New Profile Header Layout -->
        <div class="profile-header-panel">
            <img id="profile-avatar" src="assets/logo.png" class="profile-avatar-large" alt="Avatar">
            <div class="profile-details">
                <h1 id="profile-name">Loading...</h1>
                <span id="profile-steamid" class="steam-id-text">Please log in...</span>
                
                <div id="action-grid" class="profile-actions-grid"></div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>My Support Tickets</h2>
            <a href="create-ticket.html" class="btn btn-primary" style="padding: 10px 20px; font-size: 12px;">+ New Ticket</a>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Subject</th>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="ticket-body">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: #666;">Loading tickets...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="toast"></div>

    <footer>
        <div class="footer-content">
            <div class="footer-left">
                <p>&copy; 2026 Classic Rust. All rights reserved.</p>
                <p class="credits">Designed by <a href="https://aetheriwebdesign.com/" target="_blank">Aetheri Web Design</a></p>
            </div>
            <div class="footer-right">
                <a href="#">Terms of Service</a>
                <a href="#">Privacy Policy</a>
                <a href="https://discord.gg/QdQUvPvg" class="btn btn-discord-small">
                    <img src="assets/discord.png" alt="Discord" style="width: 20px; height: 20px;">
                    Join Discord
                </a>
            </div>
        </div>
    </footer>

    <script src="auth.js"></script>
    <script src="loader.js"></script>
    <script src="mobile.js"></script>
   <script>
    async function loadTickets() {
        const tbody = document.getElementById('ticket-body');
        
        try {
            const res = await fetch('/api/my-tickets', { credentials: 'include' });
            
            // Check if server returned HTML (error) instead of JSON
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("Server returned non-JSON response. Check Logs.");
            }

            const tickets = await res.json();

            // Safety check: Is it an array?
            if (!Array.isArray(tickets)) {
                console.error("Data received:", tickets);
                tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">Error: ${tickets.error || "Invalid Data"}</td></tr>`;
                return;
            }

            if (tickets.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px;">No tickets found.</td></tr>`;
                return;
            }

            tbody.innerHTML = tickets.map(t => `
                <tr onclick="window.location.href='view-ticket.html?id=${t.id}'">
                    <td>#${t.id}</td>
                    <td>${t.subject}</td>
                    <td>${t.category}</td>
                    <td>${new Date(t.created_at).toLocaleDateString()}</td>
                    <td>${t.status}</td>
                    <td><button class="btn btn-primary">View</button></td>
                </tr>
            `).join('');

        } catch (err) {
            console.error("Load Error:", err);
            tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">Failed to load tickets.</td></tr>`;
        }
    }

    // Load on start
    document.addEventListener('DOMContentLoaded', loadTickets);
</script>

</body>
</html>